# .github/workflows/ci.yml
#
# This GitHub Actions workflow provides a Continuous Integration (CI) pipeline
# for the 'thisorthat' monorepo. It ensures that code quality, linting,
# and tests are automatically checked for all pushes and pull requests to the main branch.
#
# The pipeline is optimized to run three jobs in parallel for maximum efficiency:
# 1. lint: Checks both Python and JS/TS code using a single pre-commit configuration.
# 2. backend-test: Tests the Python/FastAPI application.
# 3. frontend-test: Tests the JavaScript/React application.

name: Build, Lint, and Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ################################################################
  # Lint Job: Runs pre-commit to check all files
  ################################################################
  lint:
    name: Lint Codebase
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dev dependencies
        working-directory: ./backend
        run: |
          source ../.venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install

      - name: Run pre-commit checks
        run: |
          source backend/.venv/bin/activate
          pre-commit run --all-files

  ################################################################
  # Backend Test Job: Runs pytest
  ################################################################
  backend-test:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: lint # This job will start after the lint job is successful. You can remove this line to run it in parallel.
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}

      - name: Install Python dependencies
        working-directory: ./backend
        run: uv pip install -e ".[dev]"

      - name: Run backend tests
        working-directory: ./backend
        run: |
          source .venv/bin/activate
          pytest

  ################################################################
  # Frontend Test Job: Runs Jest and Playwright
  ################################################################
  frontend-test:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: lint # This job will start after the lint job is successful. You can remove this line to run it in parallel.
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Node.js dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install

      - name: Run Jest/RTL component tests
        working-directory: ./frontend
        # The '--watchAll=false' flag is important to prevent Jest from running in interactive watch mode in a CI environment.
        run: npm test -- --watchAll=false

      - name: Install Playwright Browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps

      - name: Run Playwright E2E tests
        working-directory: ./frontend
        run: npx playwright test
